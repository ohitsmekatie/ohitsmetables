{% extends "base.html" %}

{% block content %}
<div class="container text-center">
  <h1 class="display-5 mb-4 text-shadow-light">
    <i class="fas fa-store me-2"></i> Shop Generator
  </h1>

  <!-- Controls -->
  <div class="row justify-content-center g-3 mb-3">
    <div class="col-auto">
      <label for="storeType" class="form-label fw-bold mb-1">Store Type</label>
      <select id="storeType" class="form-select form-select-magic w-auto">
        <option value="Bakery">Bakery</option>
        <option value="Magical">Magical</option>
        <option value="General">General</option>
        <option value="Weapons">Weapons</option>
        <option value="Tavern">Tavern</option>
      </select>
    </div>

    <div class="col-auto">
      <label for="itemCount" class="form-label fw-bold mb-1"># of Items</label>
      <select id="itemCount" class="form-select form-select-magic w-auto">
        <option value="3">3</option>
        <option value="5" selected>5</option>
        <option value="8">8</option>
        <option value="12">12</option>
        <option value="20">20</option>
      </select>
    </div>

    <div class="col-auto d-flex align-items-end">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="includeKeeper" checked>
        <label class="form-check-label" for="includeKeeper">
          Include Shopkeeper
        </label>
      </div>
    </div>
  </div>

  <button class="mystic-button btn-magic mb-4" onclick="generateShop()">
    <i class="fas fa-wand-sparkles me-2"></i> Generate Shop
  </button>

  <!-- Results -->
  <div id="shopOutput" class="encounter-card result-card d-none mt-4"></div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  function el(id){ return document.getElementById(id); }

  function generateShop() {
    const type = el("storeType").value;
    const count = el("itemCount").value;
    const keeper = el("includeKeeper").checked;

    fetch(`/generate-shop?type=${encodeURIComponent(type)}&count=${encodeURIComponent(count)}&keeper=${keeper}`)
      .then(res => res.json())
      .then(data => {
        const out = el("shopOutput");
        const html = [];

        if (data.error) {
          html.push(`<p class="text-danger">❌ ${data.error}</p>`);
          out.innerHTML = html.join("");
          out.classList.remove("d-none");
          return;
        }

        html.push(`<h4 class="fw-bold mb-3">${data.store_type || type} — Inventory</h4>`);

        const items = Array.isArray(data.items) ? data.items : [];
        if (items.length === 0) {
          html.push(`<p class="mb-0">No items available.</p>`);
        } else {
          html.push('<ul class="text-start">');
          items.forEach(it => {
            const name = it["Item Name"] || it.name || "Unnamed Item";
            const desc = it["Description"] || it.description || "";
            const price = it["Price"] || it.price || "";
            const priceTxt = price ? ` — <span class="price"><em>${price}</em></span>` : "";
            const descTxt = desc ? `<div class="small text-muted">${desc}</div>` : "";
            html.push(`<li><strong>${name}</strong>${priceTxt}${descTxt}</li>`);
          });
          html.push('</ul>');
        }

        if (data.shopkeeper) {
          const { full_name, first_name, last_name, description } = data.shopkeeper;
          const displayName = full_name || [first_name, last_name].filter(Boolean).join(" ") || "Mysterious Proprietor";
          html.push(`<hr>`);
          html.push(
            `<div class="text-start">
               <p class="mb-1"><strong>Shopkeeper:</strong> ${displayName}</p>
               ${description ? `<p class="small text-muted mb-0">${description}</p>` : ""}
             </div>`
          );
        }

        out.innerHTML = html.join("");
        out.classList.remove("d-none");
        out.classList.add("show");
      })
      .catch(err => {
        const out = el("shopOutput");
        out.innerHTML = `<div class="text-danger">❌ An error occurred: ${err.message}</div>`;
        out.classList.remove("d-none");
        console.error("Fetch failed:", err);
      });
  }
</script>

{% endblock %}
